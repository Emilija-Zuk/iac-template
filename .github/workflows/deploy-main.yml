name: deploy

on:
  push:
    branches: [main]

env:
  AWS_REGION: ap-southeast-2
  ECR_REPO: iac-template-app
  ECS_CLUSTER: iac-template-cluster
  ECS_SERVICE: iac-template-svc

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: configure aws creds (static keys)
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_REGION=${{ env.AWS_REGION }}" >> $GITHUB_ENV

      - uses: aws-actions/amazon-ecr-login@v2

      - name: build and push image
        run: |
          account_id=$(aws sts get-caller-identity --query Account --output text)
          registry="${account_id}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          image="${registry}/${ECR_REPO}:latest"

          docker build -t "$image" ./app
          docker push "$image"

      - name: force new ecs deployment
        run: |
          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_SERVICE}" \
            --force-new-deployment \
            --region "${AWS_REGION}"
